#!/bin/sh
# Copyright (c) 2012-2013 Wolfram Schneider, http://bbbike.org
#
# extract-watermark - check if extract service is healthy
#

set -e

PATH=/usr/local/bin:/bin:/usr/bin; export PATH

disk=/bbbike
failed=/var/cache/extract/failed
failed2=/var/cache/extract/failed2
running=/var/cache/extract/running
: ${rename=true}

df -h $disk |tail -1 | perl -npe 's/%//' | awk '{if ($5 > 85) { print }}'

if [ $(ls $failed | wc -l) -gt 0 ]; then
    du -k $failed
    if $rename; then
	if [ -d $failed2 ]; then
	    echo ""
	    echo "cleanup to $failed2"
	    mv -f $failed/* $failed2
	fi
    fi
fi

# checked for failed running processes in run queue
( cd $running && find . -cmin +400 ! -name . -print )

