# Created by: Slaven Rezic <eserte@cs.tu-berlin.de>
@FREEBSD_IDENT@

PORTNAME=	BBBike
PORTVERSION=	@VERSION@
PORTREVISION=	1
CATEGORIES=	german
MASTER_SITES=	SF/${PORTNAME:tl}/${PORTNAME}/${PORTVERSION}

MAINTAINER=	@EMAIL@
COMMENT=	A route-finder for cyclists in Berlin and Brandenburg

BUILD_DEPENDS=	p5-Inline>=0:${PORTSDIR}/devel/p5-Inline \
		p5-CDB_File>=0:${PORTSDIR}/databases/p5-CDB_File
RUN_DEPENDS=	p5-Tk>=0:${PORTSDIR}/x11-toolkits/p5-Tk \
		${BUILD_DEPENDS}

USES=		perl5
POD2MAN=	pod2man

MYDESTDIR=	${STAGEDIR}${PREFIX}/BBBike

LOCAL_PERL_ARCH=	${PERL_ARCH}
PLIST_SUB=		LOCAL_PERL_ARCH=${LOCAL_PERL_ARCH}
BBBIKE_PERL_EXE=	@BBBIKE_PERL_EXE@

do-build:
	cd ${WRKSRC}/ext && ${MAKE} PERL=${PERL5} all install
	cd ${WRKSRC}/ext && ${MAKE} PERL=${PERL5} clean
	${FIND} ${WRKSRC}/lib -name "*.so" | ${XARGS} ${CHMOD} u+w
	${FIND} ${WRKSRC}/lib -name "*.so" | ${XARGS} ${STRIP_CMD}
	${FIND} ${WRKSRC}/lib -name "*.so" | ${XARGS} ${CHMOD} u-w
	cd ${WRKSRC}; ${POD2MAN} --lax bbbike.pod > bbbike.1
.for f in ${BBBIKE_PERL_EXE}
	${MV} ${WRKSRC}/$f ${WRKSRC}/$f.tmp
	${ECHO_CMD} "#! ${PERL}" > ${WRKSRC}/$f
	${CAT} ${WRKSRC}/$f.tmp >> ${WRKSRC}/$f
	${RM} -f ${WRKSRC}/$f.tmp
	${CHMOD} 0755 ${WRKSRC}/$f
.endfor

PLIST_IN=	${PKGDIR}/pkg-plist.in
PLIST=		${WRKDIR}/pkg-plist

pre-install:
	LOCAL_PERL_ARCH=`${PERL5} -MConfig -e '$$x = qq{$$Config{version}/$$Config{archname}}; $$x =~ s{/}{\\\\/}g; print $$x'`; \
	${SED} -e "s/%%LOCAL_PERL_ARCH%%/$$LOCAL_PERL_ARCH/g" < ${PLIST_IN} > ${PLIST}

do-install:
	-${RM} -rf ${MYDESTDIR}
	${INSTALL_MAN} ${WRKSRC}/bbbike.1 ${STAGEDIR}${PREFIX}/man/man1
	${FIND} ${WRKSRC} | ${XARGS} ${CHMOD} ugo+r
	${FIND} ${WRKSRC} -perm -u=x | ${XARGS} ${CHMOD} go+x
	${CP} -rp ${WRKSRC} ${MYDESTDIR}
	${RM} -f ${MYDESTDIR}/bbbike.1
.for f in ${BBBIKE_PERL_EXE}
	-${RM} -f ${STAGEDIR}${PREFIX}/bin/$f
	${LN} -s  ../BBBike/$f ${STAGEDIR}${PREFIX}/bin/$f
.endfor

.include <bsd.port.mk>
