#!/bin/sh
# Copyright (c) Mar 2013 Wolfram Schneider, http://bbbike.org
#
# planet-download-replication - replicate daily planet.os.pbf
#

set -e

: ${MD5=`which md5 md5sum false | head -1`}
: ${SHA="shasum -a 256"}

nice="nice -n 9"

file=planet-latest.osm.bz2
planet_osm_replication_server=http://planet.openstreetmap.org

if [ -e $HOME/.bbbikerc ]; then 
    . $HOME/.bbbikerc
fi

download_dir=$HOME/projects/osm/download/pbf

# current status
status_file=.status

cd $download_dir
if [ -e $status_file -a -s $status_file ]; then
    status_number=$(cat $status_file)
else
    echo "No $status_file found, give up"
    exit 2
fi

tmp=$(mktemp)
curl -sSf $planet_osm_replication_server/replication/day/state.txt > $tmp
sequence_number=$(perl -ne 'print "$1\n" if /sequenceNumber=(\d+)/' $tmp)

if [ -z $sequence_number ]; then
    echo "No sequenceNumber found, give up"
    exit 2
fi

# 4323 -> 000/004/323
replication_path ()
{
    n=$1
    path=$(perl -e '$a=shift; while(length($a) < 9) { $a = "0" . $a}; $a =~ /^(\d{3})(\d{3})(\d{3})/; print "$1/$2/$3\n"' $n )
    echo "$path"
}

if [ $status_number -lt $sequence_number ]; then
    echo "need to update: $status_number ... $sequence_number"
    number=$status_number
    while [ $number -lt $sequence_number ]; do
        number=$(expr $number + 1)
        
        file=$number.osc.gz
        if [ -e $file ]; then
            :
        else
            path=$(replication_path $number)
            wget -q $planet_osm_replication_server/replication/day/$path.osc.gz
        fi
        
    done
    echo $sequence_number > $status_file
   
    time osmconvert planet-latest.osm.pbf *osc.gz -o=planet.new.$$.pbf
    mv -f planet.new.$$.pbf planet.new.pbf
fi

rm -f $tmp
