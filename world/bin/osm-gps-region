#!/bin/sh
#
# extract street names coords from an OpenStreetMap XML dump and
# compute the region area (country, state)
#
# usage: osm2suggestions osm_filename [outdirectory]
#

filename=$1
: ${outdir=$2}

if test -z "$filename"; then
	echo "missing file name"
	exit 2
fi

if test -z "$outdir"; then 
	outdir=/tmp/gps
fi

outdir=`echo $outdir | perl -npe 's/\.osm(\.gz|\.bz2|)$//'`
mkdir -p $outdir || exit 2

file=`basename $filename | perl -npe 's/\.osm(\.gz|\.bz2|)$//'`
area=`echo $filename | perl -npe 's/\.osm(\.gz|\.bz2|)$//'`

if ! extract-streetnames-osm --debug=2 --uniq=0 --sort=0 $filename > $outdir/$file.tmp 2> $outdir/$file.log; then
    exit 1
fi

perl -npe "s/^.*?\t//; s,\n,\t$area\n," $outdir/$file.tmp | gzip > $outdir/$file.gz
rm -f $outdir/$file.tmp

exit 0
