#!/bin/sh
# Copyright (c) 2009-2012 Wolfram Schneider, http://bbbike.org
#
# pbf2osm - convert PBF format to OSM XML

set -e

compress=""
gzip=`which pigz gzip | head -n 1`
bzip2=`which pbzip2 bzip2 | head -n 1`
osm2garmin=`dirname $0`/osm2garmin
osm2shape=`dirname $0`/osm2shape
osm2osmand=`dirname $0`/osm2osmand
osm2navit=`dirname $0`/osm2navit

xz=`which xz | head -n 1`
xz_opt=-2
if which pixz >/dev/null; then
    xz="pixz -t"
fi

case $1 in
  # single core, more than one *.pbf files at once
  -gzip | --gzip)    shift; compress=gzip;;
  -bzip2 | --bzip2 ) shift; compress=bzip2 ;;

  # multi-core
  --pbzip2 ) shift; compress=pbzip2 ;;
  --pgzip ) shift; compress=pgzip ;;

  -xz | --xz )       shift; compress=xz ;;
  -shape | --shape | -shp | --shp | --shapefile ) shift; compress=shape ;;
  -osmand | --osmand | -obf | --obf ) shift; compress=osmand ;;
  -navit | --navit ) shift; compress=navit ;;

  -garmin | --garmin ) shift; compress=garmin; garmin_style=$2 ;;
  -garmin-osm | --garmin-osm ) shift; compress=garmin; garmin_style=osm ;;
  -garmin-cycle | --garmin-cycle ) shift; compress=garmin; garmin_style=cycle ;;
  -garmin-leisure | --garmin-leisure ) shift; compress=garmin; garmin_style=leisure ;;
esac

file=$1
city="$2"

if ! [ -f "$file" ]; then
	echo "usage file"
	exit 1
fi

# run in quiet mode
global_opt=-q

osm2osm () {
compressionMethod=$1
shift
case $compressionMethod in
  gzip ) ext=.gz ;;
  bzip2 ) ext=.bz2 ;;
  * ) echo "unknown compress $compressionMethod"; exit 2;;
esac

args=""
for f 
do
   ff=`echo $f | sed "s/\.pbf$/$ext.tmp/"`
   args="$args --read-pbf $f --write-xml $ff compressionMethod=$compressionMethod"
done


if osmosis $global_opt $args 
then
    for f 
    do
        ff=`echo $f | sed "s/\.pbf$/$ext/"`
        mv -f $ff.tmp $ff
        chmod 664 $ff
    done
else
    echo "File $@ failed"
    exit 2
fi 
}



if [ "$compress" = "" ]; then
    osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout 
else
    f=`basename $file .pbf`
    dir=`dirname $file`
    case $compress in
	gzip )  osm2osm $compress "$@";;
	bzip2 ) osm2osm $compress "$@";;

	pgzip ) osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout | $gzip > $dir/$f.tmp; mv -f $dir/$f.tmp $dir/$f.gz ;;
	pbzip2 ) osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout | $bzip2 > $dir/$f.tmp; mv -f $dir/$f.tmp $dir/$f.bz2 ;;

	xz ) osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout | $xz $xz_opt > $dir/$f.tmp; mv -f $dir/$f.tmp $dir/$f.xz ;;
	garmin ) $osm2garmin "$file" "$garmin_style" "$city" ;;
	shape )  $osm2shape  "$file" "$city" ;;
       	osmand ) $osm2osmand "$file" "$city" ;;
       	navit )  $osm2navit  "$file" "$city" ;;

	* ) echo >& 2 "Oops, unknown '$compress'"; exit 2 ;;
    esac
fi

