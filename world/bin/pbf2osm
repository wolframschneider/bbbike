#!/bin/sh
# Copyright (c) 2009-2012 Wolfram Schneider, http://bbbike.org
#
# pbf2osm - convert PBF format to OSM XML

set -e

compress=""
gzip=`which pigz gzip | head -n 1`
bzip2=`which pbzip2 bzip2 | head -n 1`
osm2garmin=`dirname $0`/osm2garmin
osm2shape=`dirname $0`/osm2shape

xz=`which xz | head -n 1`
xz_opt=-2
if which pixz >/dev/null; then
    xz="pixz -t"
fi

case $1 in
  -gzip | --gzip)    shift; compress=gzip;;
  -bzip2 | --bzip2 ) shift; compress=bzip2 ;;
  -xz | --xz )       shift; compress=xz ;;
  -garmin | --garmin ) shift; compress=garmin; garmin_style=$2 ;;
  -shape | --shape | -shp | --shp ) shift; compress=shape ;;
  -osmand | --osmand | -obf | --obf ) shift; compress=osmand ;;
esac

file=$1

if ! [ -f "$file" ]; then
	echo "usage file"
	exit 1
fi

# run in quiet mode
global_opt=-q

if [ "$compress" = "" ]; then
    osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout 
else
    f=`basename $file .pbf`
    dir=`dirname $file`
    case $compress in
	gzip ) osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout | $gzip > $dir/$f.tmp 
		mv -f $dir/$f.tmp $dir/$f.gz		
		;;
	bzip2 ) osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout | $bzip2 > $dir/$f.tmp 
		mv -f $dir/$f.tmp $dir/$f.bz2		
		;;
	xz ) osmosis $global_opt --read-pbf "$file" --write-xml /dev/stdout | $xz $xz_opt > $dir/$f.tmp 
		mv -f $dir/$f.tmp $dir/$f.xz		
		;;

	garmin ) $osm2garmin "$file" $garmin_style 
		;;
	shape ) $osm2shape "$file"
		;;
       	osmand ) $osm2osmand "$file"
		;;

	* ) echo >& 2 "Oops, unknown '$compress'"; exit 2 ;;
    esac
fi

