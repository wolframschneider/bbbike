#!/bin/sh
# Copyright (c) 2009-2011 Wolfram Schneider, http://bbbike.org
#
# ncpu - detect the number of CPUs on a machine
#

PATH=/bin:/usr/bin:/sbin:/usr/sbin; export PATH

cpuinfo=/proc/cpuinfo
minus=0
vcpu=0
rcpu=0

case $1 in
	vcpu ) vcpu=1; shift ;;
	rcpu ) rcpu=1; shift ;;
esac

case $1 in
	-1 | -2 | +1|+2|+3|+4|+6|+8 ) minus=$1 ;;
esac


# macos
if sysctl -n hw.physicalcpu > /dev/null 2>&1; then
  # with virtual CPUs
  if [ $vcpu = 1 ]; then
     ncpu=`sysctl -n hw.ncpu`

  # real CPUs + 1/2 virtual CPUs
  elif [ $rcpu = 1 ]; then
     ncpu=`perl -e 'print (($ARGV[0] + $ARGV[1])/2)' $(sysctl -n hw.ncpu) $(sysctl -n hw.physicalcpu)`

  # physical CPUs only
  else
     ncpu=`sysctl -n hw.physicalcpu`
  fi

# linux
elif  [ -f $cpuinfo ]; then
  ncpu=`egrep -c ^processor $cpuinfo`
  cores=`awk '{ if (/^cpu cores/) { print $4; exit }}' $cpuinfo`

  if [ $vcpu = 1 ]; then
	:
  # real CPUs + 1/2 virtual CPUs
  elif [ $rcpu = 1 ]; then
     ncpu=`perl -e 'print (($ARGV[0] + $ARGV[1])/2)' $ncpu $cores`
  else
     ncpu=$cores
  fi
fi

ncpu=`perl -e "print $ncpu + $minus"`
if [ "$ncpu" -ge 1 -a "$ncpu" -le 64 ]; then
	echo "$ncpu"
else
	echo "1"
fi

