#!/bin/sh
# Copyright (c) 2009-2012 Wolfram Schneider, http://bbbike.org
#
# ncpu - detect the number of CPUs on a machine
#

PATH=/bin:/usr/bin:/sbin:/usr/sbin; export PATH

cpuinfo=/proc/cpuinfo

minus=0
vcpu=0
rcpu=0

case $1 in
	vcpu ) vcpu=1; shift ;;
	rcpu ) rcpu=1; shift ;;
	ncpu ) shift ;;
	"" | -* | +* ) ;;
	*    ) echo "usage $0 [ vcpu | rcpu ] [ -/+ number ]"; exit 1;;
esac

case $1 in
	-1 | -2 | +1|+2|+3|+4|+6|+8 ) minus=$1 ;;
esac


# macos
if sysctl -n hw.physicalcpu > /dev/null 2>&1; then
  # with virtual CPUs
  if [ $vcpu = 1 ]; then
     ncpu=`sysctl -n hw.ncpu`

  # real CPUs + 1/2 virtual CPUs
  elif [ $rcpu = 1 ]; then
     ncpu=`perl -e 'print (($ARGV[0] + $ARGV[1])/2)' $(sysctl -n hw.ncpu) $(sysctl -n hw.physicalcpu)`

  # physical CPUs only
  else
     ncpu=`sysctl -n hw.physicalcpu`
  fi

  # Xen machine?
  if [ -e $HOME/.ncpu.ncpu ]; then
    ncpu=`cat $HOME/.ncpu.ncpu`
  fi

# linux
elif  [ -f $cpuinfo ]; then
  ncpu=`egrep -c '^physical id.: 0$' $cpuinfo`
  cores=`egrep -c '^processor' $cpuinfo`

  # Xen machine?
  if [ $ncpu = 0 -a -e $HOME/.ncpu.ncpu ]; then
    ncpu=`cat $HOME/.ncpu.ncpu`
  fi


  if [ $vcpu = 1 ]; then
    ncpu=$cores

  # real CPUs + 1/2 virtual CPUs
  elif [ $rcpu = 1 ]; then
     ncpu=`perl -e 'print int(($ARGV[0] + $ARGV[1])/2)' $ncpu $cores`

  # a virtual server with 4 cores and 3 virtuals cpu's available
  elif [ $ncpu -gt $cores ]; then 
     ncpu=$cores
  fi

  # local host config
  if [ -e $HOME/.ncpu -a ! -e $HOME/.ncpu.ncpu ]; then
    ncpu=`cat $HOME/.ncpu`
  fi
fi

# +/-
ncpu=`perl -e "print $ncpu + $minus"`

# print valid output
if [ "$ncpu" -ge 1 -a "$ncpu" -le 64 ]; then
	echo "$ncpu"
else
	echo "1"
fi

