#!/bin/sh
# Copyright (c) 2010 Wolfram Schneider, http://bbbike.org
#
# ncpu - detect the number of CPUs on a machine
#

PATH=/bin:/usr/bin:/sbin:/usr/sbin; export PATH

minus=0
case $1 in
	-1 | -2 | +1 | +2) minus=$1 ;;
esac

ncpu=3
if sysctl -n hw.ncpu > /dev/null 2>&1; then
  # macos
  ncpu=`sysctl -n hw.ncpu`
elif sysctl kernel.sched_domain >/dev/null 2>&1; then
  # linux
  ncpu=`sysctl  kernel.sched_domain | tail -1 | \
	perl -ne 'print ($1+1), "\n" if m,kernel.sched_domain.cpu(\d+),'`
fi

ncpu=`perl -e "print $ncpu + $minus"`
if [ "$ncpu" -ge 1 -a "$ncpu" -le 64 ]; then
	echo "$ncpu"
else
	echo "1"
fi

