#!/bin/sh
# Copyright (c) 2012-2013 Wolfram Schneider, http://bbbike.org
#
# osm2pbf - convert OSM XML to PBF format

file=$1
: ${osm_checksum=`dirname $0`/osm-checksum}

if ! [ -e "$file" ]; then
	echo "usage file"
	exit 1
fi

# /dev/stdin
if ! [ -f "$file" ]; then
    osm_checksum=true
fi

gzip=`which pigz gzip | head -n 1`
bzip2=`which pbzip2 bzip2 | head -n 1`

file_pbf=`echo "$file" | perl -npe 's/\.[^\.]+$/.pbf/'`

case $file in 
	*.gz )  uncompress="$gzip -dc" ;;
	*.bz2 ) uncompress="$bzip2 -dc" ;;
	*.zip | *.ZIP ) uncompress="unzip -p" ;;
	/dev/stdin ) uncompress="cat"; file_pbf=/dev/stdout ;;
	*) exit 2 ;;
esac


# run in quiet mode
global_opt=-q

if $uncompress "$file" | osmosis $global_opt --read-xml enableDateParsing=no /dev/stdin --buffer bufferCapacity=2000 \
	--write-pbf $file_pbf omitmetadata=true granularity=10000
then
    :
else
    echo "File $file failed"
    $uncompress -t $file
    exit 2
fi 

$osm_checksum $file_pbf
$osm_checksum $file

# relative path names in *.md5 files
for i in $file_pbf.md5 $file.md5 $file_pbf.sha256 $file.sha256
do
   if [ -e $i ]; then
	perl -i -npe 's,(\s+).+/,$1,g' $i
   fi
done

