#!/bin/sh
# Copyright (c) 2012-2013 Wolfram Schneider, http://bbbike.org
#
# osm2mapsforge - convert a osm/pbf file to mapsforge
#

set -e
PATH=$HOME/bin:/bin:/usr/bin; export PATH

usage () {
   echo "$@"
   echo "usage file [ style ] [ title ]"
   echo ""
   echo "style: osm"
   exit 1
}

error () {
    message="$@"

    echo "$message"
    echo "file: $file"
    cat $logfile
    exit 1
}

file=$1
city=$3

map_style="osm"

# absolute file path
case $file in /*) ;; *) file=$(pwd)/$file ;; esac

text2html=$(dirname $0)/text2html.sh
case $text2html in /*) ;; *) text2html=$(pwd)/$text2html ;; esac

test -e "$file" || usage "file $file does not exists"
: ${osm_checksum=`dirname $0`/osm-checksum}

test -z "$ext" && ext=${2-"osm"}
: ${debug=false}

size=$(du -ks -L "$file" | awk '{ print $1}')
: ${java_heap=2048M}
if [ $size -gt 250000 ]; then
   java_heap=4948M
elif [ $size -gt 150000 ]; then
   java_heap=3748M
elif [ $size -gt 100000 ]; then
   java_heap=3248M
fi

#case $ext in *leisure* ) java_heap=3500M ;; esac

pwd=$(pwd)
java_opt=-Xmx${java_heap}

etc_dir=`dirname $0`/../etc/mkgmap
# absolute path
case $etc_dir in /* ) ;; *) etc_dir=$pwd/$etc_dir ;; esac

case $ext in
   osm | mapsforge-osm.zip )
	ext=mapsforge-osm.zip
	;;

   *) usage ;;
esac


test -z "$file" && usage

tmpdir=`mktemp -d ${TMPDIR-"/bbbike/tmpfs"}/mapsforge.$(basename $ext .zip).XXXXXXXXXXX`

mapsforge=`basename $file | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
mapsforge_dir=$tmpdir/$mapsforge-`basename $ext .zip`
mkdir -p $mapsforge_dir

logfile=$mapsforge_dir/logfile.txt
touch $logfile

# mkgmap bug
if [ ! -s $file ]; then
    : #error "file size is zero, give up!"
fi

date=$(date -u)
coords=$(echo $mapsforge | perl -npe 's,planet_,,; s/_/ /g')
description=$(echo $description | perl -npe '$_=substr($_,0,50)')

cd $mapsforge_dir

cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org
Extracts created by BBBike, http://BBBike.org
mapsforge map writer by http://mapsforge.org


Please read the OSM wiki how to install the maps on your Android device:

  http://wiki.openstreetmap.org/wiki/Mapsforge
  http://code.google.com/p/mapsforge/


This mapsforge map was created on: $date
Mapsforge map style: $map_style
GPS rectangle coordinates (lng,lat): $BBBIKE_EXTRACT_COORDS
Script URL: $BBBIKE_EXTRACT_URL
Name of area: $city

We appreciate any feedback, suggestions and a donation! You can support us via
PayPal, Flattr or bank wire transfer: http://www.BBBike.org/community.html

thanks, Wolfram Schneider

--
http://www.BBBike.org - Your Cycle Route Planner
EOF

$text2html < README.txt > README.html

echo ">>> Run osmosis, mapsforge writer map style: $map_style" >> $logfile
osmosis --read-pbf $file --mapfile-writer file=$mapsforge.map >> $logfile  2>&1 || error

if egrep -ql '^java\.lang\.|OsmosisRuntimeException' $logfile; then
    error
fi

cd ..
mapsforge_zip=`dirname $file`/$mapsforge.osm.$ext
zip -q -r - -- `basename $mapsforge_dir` | \
  ( cd $pwd;
    cat > $mapsforge_zip.tmp && mv $mapsforge_zip.tmp $mapsforge_zip
    $osm_checksum $mapsforge_zip
  )

$debug || rm -rf $tmpdir
