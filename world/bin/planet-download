#!/bin/sh
# Copyright (c) 2009-2011 Wolfram Schneider, http://bbbike.org
#
# planet-download - download the latest planet osm file
#

if [ -n "$IGNORE_PLANET_OSM" ]; then
	exit 0
fi

: ${MD5=`which md5 md5sum | head -1`}
nice="nice -n 9"

file=planet-latest.osm.bz2
file_bpf=`basename $file .bz2`.pbf
dir="tmp.$$.new"


#server1=http://ftp5.gwdg.de/pub/misc/openstreetmap/planet.openstreetmap.org
#server2=http://ftp.ecki-netz.de/osm
#server2=$server1
#server1=http://ftp.heanet.ie/mirrors/openstreetmap.org
server1=http://planet.openstreetmap.org

mkdir -p $dir
pwd=`pwd`
cd $dir || exit

wget -nv $server1/$file.md5
#wget -nv $server1/$file

time curl -L -sS $server1/$file | tee $file | $nice pbzip2 -dc | buffer | \
  $nice time osmosis  --rx enableDateParsing=no /dev/stdin --buffer bufferCapacity=12000 --write-pbf $file_bpf omitmetadata=true granularity=10000

# file size check of planet.osm.bz2
new=`lynx -source -head $server1/$file | perl -ne 'print "$1\n" if /^Content-Length:\s+(\d+)/'`
cache_file=$file
if [ -e  $cache_file ]; then
   old=`ls -l $cache_file | awk '{ print $5 }'`
fi
if [ $new -ne $old ]; then
   echo "file size mismatch: $old <-> $new"
   exit 2
fi

cat $file.md5
$MD5 $file | tee $file.md5
$MD5 $file_bpf | tee $file_bpf.md5

cd $pwd
mv -f $file.md5 $file.md5.old.$$
mv -f $file $file.old.$$
mv -f $file_bpf $file_bpf.old.$$

mv -f $dir/$file $dir/$file.md5 $dir/$file_bpf $dir/$file_bpf.md5 .
rm -rf $dir

