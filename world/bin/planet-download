#!/bin/sh
# Copyright (c) 2009-2011 Wolfram Schneider, http://bbbike.org
#
# planet-download - download the latest planet osm file
#

set -e

if [ -n "$IGNORE_PLANET_OSM" ]; then
	exit 0
fi

: ${MD5=`which md5 md5sum | head -1`}
nice="nice -n 9"

file=planet-latest.osm.bz2
file_bpf=`basename $file .bz2`.pbf
dir="tmp.$$.new"

#server=http://ftp.heanet.ie/mirrors/openstreetmap.org
server=http://planet.openstreetmap.org
server=http://download.bbbike.org/osm/planet

mkdir -p $dir
pwd=`pwd`
cd $dir

# get md5 checksum first
curl -sS -o $file.md5 $server/$file.md5

time curl -L -sS $server/$file | tee $file | $nice pbzip2 -dc | buffer | \
  $nice time osmosis  --rx enableDateParsing=no /dev/stdin --buffer bufferCapacity=12000 --write-pbf $file_bpf omitmetadata=true granularity=10000

cat $file.md5
$MD5 $file | tee $file.md5
$MD5 $file_bpf | tee $file_bpf.md5

cd $pwd
mv -f $file.md5 $file.md5.old.$$
mv -f $file $file.old.$$
mv -f $file_bpf $file_bpf.old.$$

mv -f $dir/$file $dir/$file.md5 $dir/$file_bpf $dir/$file_bpf.md5 .
rm -rf $dir

