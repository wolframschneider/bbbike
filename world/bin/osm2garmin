#!/bin/sh
# Copyright (c) 2012 Wolfram Schneider, http://bbbike.org
#
# osm2garmin - convert a osm/pbf file to garmin
#

set -e
PATH=$HOME/bin:/bin:/usr/bin; export PATH

usage () {
   echo "$@"
   echo "usage file [ osm | cycle | leisure ] [ title ]"
   exit 1
}

error () {
    message="$@"
    
    echo "$message"
    echo "file: $file"
    cat $logfile
    exit 1
}

file=$1
city=$3

# absolute file path
case $file in /*) ;; *) file=$(pwd)/$file ;; esac

test -e "$file" || usage "file $file does not exists"
: ${osm_checksum=`dirname $0`/osm-checksum}

test -z "$ext" && ext=${2-"osm"}
: ${debug=false}

size=$(du -ks -L "$file" | awk '{ print $1}')
: ${java_heap=2048M}
if [ $size -gt 500000 ]; then
   java_heap=3548M
elif [ $size -gt 100000 ]; then
   java_heap=2548M
fi

case $ext in 
  *leisure* ) java_heap=3500M ;;
esac

pwd=$(pwd)
java_opt=-Xmx${java_heap} 
mkgmap_opt='--gmapsupp --family-id=23 --remove-short-arcs --route --net --index --add-pois-to-areas'
mkgmap_map_style="osm"
: ${max_jobs=""}

case $ext in 
   cycle | garmin-cycle.zip ) 
	ext=garmin-cycle.zip
	mkgmap_map=--style-file=$pwd/world/etc/mkgmap/cyclemap
	mkgmap_map_style=cyclemap
	mkgmap_map_type=$pwd/world/etc/mkgmap/cyclemap.TYP
	;;

   leisure | freizeit | garmin-freizeit.zip | garmin-leisure.zip ) 
	ext=garmin-leisure.zip
	mkgmap_map=--style-file=$pwd/world/etc/mkgmap/freizeit
	mkgmap_map_style=freizeit
	mkgmap_map_type=$pwd/world/etc/mkgmap/freizeit.TYP
	;;

   osm | garmin-osm.zip ) 
	ext=garmin-osm.zip
	;;

   *) usage ;;
esac


test -z "$file" && usage
if [ -n "$mkgmap_map_type" ]; then
   test -e "$mkgmap_map_type" || usage "cannot find $mkgmap_map_type file"
fi

tmpdir=`mktemp -d ${TMPDIR-"/bbbike/tmp"}/garmin.XXXXXXXXXXX`
split_dir=$tmpdir/split
mkdir -p $split_dir

garmin=`basename $file | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
garmin_dir=$tmpdir/$garmin-`basename $ext .zip`
mkdir -p $garmin_dir

logfile=$garmin_dir/logfile.txt
touch $logfile

if [ ! -s $file ]; then
    error "file size is zero, give up!"
fi

if [ $size -lt 10000 ]; then
   echo "PBF file size $size KB, run without splitter" > $logfile
   ln -s $file $split_dir/63240001.osm.pbf
else 
   echo ">>> Run splitter" > $logfile
   java $java_opt -jar $HOME/opt/splitter/splitter.jar --output-dir=$split_dir $file >> $logfile 2>&1 || error
fi

if [ -z "$city" ]; then
   description="$garmin"
else
   description="$garmin $city"
fi

cd $garmin_dir
echo ">>> Run mkgmap, map type: $mkgmap_map_style" >> $logfile
java $java_opt -jar $HOME/opt/mkgmap/mkgmap.jar $max_jobs $mkgmap_opt $mkgmap_map \
	--description="$city" --family-name="OpenStreetmap - BBBike.org - $garmin" $split_dir/*.pbf $mkgmap_map_type >> $logfile 2>&1 || error

if egrep -ql 'java.lang.OutOfMemoryError' $logfile; then
    error
fi

case $mkgmap_opt in
  *--gmapsupp* ) rm -f osmmap.tdb osmmap.img [0-9][0-9]*.img ;;
esac
	
date=$(date -u)
cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org
Extracts created by BBBike.org, Map style: $mkgmap_map_style

This garmin map was created on: $date
Area: $city

Please read the OSM wiki how to install the maps on your GPS device:

  http://wiki.openstreetmap.org/wiki/OSM_Map_On_Garmin#Installing_the_map_onto_your_GPS
  http://wiki.openstreetmap.org/wiki/OSM_Map_On_Garmin/Download


thanks, Wolfram Schneider

--
http://www.BBBike.org - Your Cycle Route Planner
We appreciate any feedback, suggestions and a donation!
EOF

cd ..
garmin_zip=`dirname $file`/$garmin.osm.$ext
zip -q -r - -- `basename $garmin_dir` | \
  ( cd $pwd;
    cat > $garmin_zip.tmp && mv $garmin_zip.tmp $garmin_zip 
    $osm_checksum $garmin_zip
  )

$debug || rm -rf $tmpdir

