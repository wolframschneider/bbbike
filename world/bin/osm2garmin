#!/bin/sh
# Copyright (c) 2012 Wolfram Schneider, http://bbbike.org
#
# osm2garmin - convert a osm/pbf file to garmin
#


PATH=$HOME/bin:/bin:/usr/bin; export PATH
file=$1

set -e

usage () {
   echo "usage file"
   exit 1
}

test -z "$file" && usage

pwd=$(pwd)
tmpdir=`mktemp -d ${TMPDIR-"/bbbike/tmp"}/garmin.XXXXXXXXXXX`
split_dir=$tmpdir/split
mkdir -p $split_dir

garmin=`basename $file | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
garmin_dir=$tmpdir/$garmin
mkdir -p $garmin_dir

exec > $garmin_dir/logfile.txt 2>&1

java -Xmx2000m -jar $HOME/opt/splitter/splitter.jar --output-dir=$split_dir $file

cd $garmin_dir
mkgmap $split_dir/*.pbf
cd ..

cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org

Extracts are created and updated by http://www.bbbike.org
EOF

garmin_zip=`dirname $file`/$garmin.garmin.zip
zip -r - $garmin | (cd $pwd;  cat > $garmin_zip.tmp && mv $garmin_zip.tmp $garmin_zip )

rm -rf $tmpdir

