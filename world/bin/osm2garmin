#!/bin/sh
# Copyright (c) 2012 Wolfram Schneider, http://bbbike.org
#
# osm2garmin - convert a osm/pbf file to garmin
#


set -e
PATH=$HOME/bin:/bin:/usr/bin; export PATH
file=$1
test -z "$ext" && ext=${2-"garmin-osm.zip"}
: ${debug=false}

size=$(du -ks -L "$file" | awk '{ print $1}')
java_heap=801
if [ $size -gt 500000 ]; then
   java_heap=2400
elif [ $size -gt 100000 ]; then
   java_heap=1600
fi

md5sum=`which md5 md5sum false | head -n 1`
: ${SHA="shasum -a 256"}

pwd=$(pwd)
java_opt=-Xmx${java_heap}M 
mkgmap_opt='--gmapsupp --family-id=23 --remove-short-arcs --route --net'
mkgmap_map_style="osm"

case $ext in 
   garmin-cycle.zip ) 
	mkgmap_map=--style-file=$pwd/world/etc/mkgmap/cyclemap
	mkgmap_map_style=cyclemap
	mkgmap_map_type=$pwd/world/etc/mkgmap/cyclemap.TYP
	;;
esac

usage () {
   echo "usage file [ extention ]"
   exit 1
}

test -z "$file" && usage

tmpdir=`mktemp -d ${TMPDIR-"/bbbike/tmp"}/garmin.XXXXXXXXXXX`
split_dir=$tmpdir/split
mkdir -p $split_dir

garmin=`basename $file | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
garmin_dir=$tmpdir/$garmin
mkdir -p $garmin_dir

$debug || exec > $garmin_dir/logfile.txt 2>&1

java $java_opt -jar $HOME/opt/splitter/splitter.jar --output-dir=$split_dir $file

cd $garmin_dir
java $java_opt -jar $HOME/opt/mkgmap/mkgmap.jar $mkgmap_opt $mkgmap_map \
	--description="$garmin" --family-name="OpenStreetmap - BBBike.org" $split_dir/*.pbf $mkgmap_map_type

case $mkgmap_opt in
  *--gmapsupp* ) rm -f osmmap.tdb osmmap.img [0-9][0-9]*.img ;;
esac
	

cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org
Extracts created by BBBike.org, Map style: $mkgmap_map_style

Please read the OSM wiki how to install the maps on your GPS device:

  http://wiki.openstreetmap.org/wiki/OSM_Map_On_Garmin
  http://wiki.openstreetmap.org/wiki/OSM_Map_On_Garmin/Download


thanks, Wolfram Schneider

--
http://www.BBBike.org - Your Cycle Route Planner
We appreciate any feedback, suggestions and a donation!
EOF

cd ..
garmin_zip=`dirname $file`/$garmin.osm.$ext
zip -r - -- $garmin | \
  ( cd $pwd;
    cat > $garmin_zip.tmp && mv $garmin_zip.tmp $garmin_zip 
    $md5sum $garmin_zip > $garmin_zip.md5
    $SHA $garmin_zip > $garmin_zip.sha256
  )

$debug || rm -rf $tmpdir

