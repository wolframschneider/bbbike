#!/bin/sh
# Copyright (c) Sep 2011-2015 Wolfram Schneider, http://bbbike.org
#
# usage: /etc/munin/plugins/bbbike-extract-diskusage [ config ]
#
# get documentation with: perldoc /path/to/script

: << =cut

=head1 NAME

munin-bbbike-extract-size  - Plugin to monitor average file size

=head1 ABOUT

Munin plugin to monitor to bbbike extract average file size
[...]

=head1 USAGE

[...]

=head1 CONFIGURATION

Configuration parameters for /etc/munin/plugin-conf.d/munin-node
if you need to override the defaults below:

 [bbbike-extract-diskusage]
   env.warning   - Generate a warning if disk usage goes above this level
   env.critical  - Generate a critical if disk usage goes above this level

=cut


PATH=/bin:/usr/bin; export PATH
extract_dir=/var/cache/extract
formats="csv.gz csv.xz garmin-bbbike.zip garmin-cycle.zip garmin-leisure.zip garmin-osm.zip mapsforge-osm.zip navit.zip o5m.gz o5m.xz obf.zip osm.bz2 osm.gz osm.pbf osm.xz shp.zip srtm-europe.garmin-srtm.zip srtm-europe.obf.zip srtm-europe.osm.pbf srtm.garmin-srtm.zip srtm.obf.zip srtm.osm.pbf"

config=$1

if [ "$1" = "config" ]; then
    : ${warning=80000000}
    : ${critical=120000000}
     
    cat <<EOF
graph_args --base 1024 --lower-limit 0
graph_title Average Extracts size
graph_vlabel Average Extracts size
graph_category BBBike
graph_info File size
graph_period minute
EOF
    for f in $formats
    do
        echo "$f.label $f"
        echo "$f.min 0"
        echo "$f.warnings $warning"
        echo "$f.critical $critical"
    done

    exit 0
fi

for f in $formats
do
    echo "$f.value"     `( cd $extract_dir/download; du -k * | egrep "${f}$" | awk '{ s += $1 } END { printf("%d", NR ? s * 1 / NR : 0)  }' )`
done
