#!/bin/sh
# Copyright (c) 2009-2012 Wolfram Schneider, http://bbbike.org
#
# bbbike-merge - git merge from bbbike.de / master branch

set -e
: ${verbose=true}
: ${debug=false}

dir=`dirname $0`
PATH=$PATH:$dir; export PATH 

command="$@"

tmpdir=/bbbike/tmp
if [ -d $tmpdir ]; then
   TMPDIR=$tmpdir; export TMPDIR
fi

dir=$(mktemp -d -t bbbike-bootstrap.XXXXXXXX)
cd $dir

logfile=$(pwd)/log.bbbike
$debug || exec 2> $logfile

error () {
   message="$@"
   echo $message
   cat $logfile
   exit 2
}

bbbike-checkout >&2 || error "checkout failed: $dir"
cd bbbike

git_opt=""
$verbose || git_opt="-q"
if ! git merge $git_opt eserte/master; then
   echo "merged failed: $dir"
   exit 1
fi

make -s js perltidy || error "js perltidy"
make -s update-files  || error "update-files"
git diff

if $verbose; then
    pwd
    if [ -n "$command" ]; then
	$command
    fi
    echo "please run: $ rm -rf $dir"
else
    rm -rf $dir
fi

