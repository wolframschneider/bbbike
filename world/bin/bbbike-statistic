#!/bin/sh
# Copyright (c) 2009-2011 Wolfram Schneider, http://bbbike.org
#
# bbbike-statistic - command line bbbike @ world statistic


PATH=$HOME/bin:$PATH; export PATH

cd /var/log/lighttpd || exit 2

: ${logfiles="bbbike.log"}
: ${logfiles_mobile="m.bbbike.log"}

url_match='(/cgi/[A-Zb]|/[A-Z][a-z]+/|/berlin/|/[a-z][a-z]/[A-Z][a-z]+/)'

echo -n "bbbike.org page views: "
zcat -f $logfiles | egrep "GET $url_match" | egrep -v '" 40[34] ' | awk '{print $1}' | wc -l

echo -n "mobile bbbike.org page views: "
zcat -f $logfiles_mobile | egrep "GET $url_match" | egrep -v '" 40[34] ' | awk '{print $1}' | wc -l

echo -n "weather page views: "
zcat -f $logfiles | egrep 'GET /cgi/weather.cgi' | egrep -v '" 40[34] ' | awk '{print $1}' | wc -l

echo -n "location page views: "
zcat -f $logfiles $logfiles_mobile | egrep 'GET /cgi/location.cgi' | egrep '" (200|301) ' | awk '{print $1}' | wc -l

echo ""
echo -n "bbbike.org hosts: "
zcat -f $logfiles | egrep "GET $url_match" | egrep -v '" 40[34] ' | awk '{print $1}' | sort -u | wc -l
zcat -f $logfiles | egrep "GET $url_match" | egrep -v '" 40[34] ' |  
	egrep -v 'Purebot|Java/1|SnapPreviewBot|Tcl http client package|Yahoo\! Slurp|www.bing.com/bingbot.htm|crawler.html|Googlebot|ezooms.bot|covario|Ronbot/Nutch' |
	awk '{print $1, $7 }' | perl -npe 's/\?.*//; s,/cgi/,,; s,(\.en)?\.cgi,,;' | 
	sort | uniq -c | sort -nr | head -20 | dns

echo ""

echo ""
echo "bbbike references:"
zcat -f $logfiles | egrep "GET / |GET $url_match.+ HTTP" | egrep '" (200|301) ' |
	egrep -v 'Purebot|Java/1|SnapPreviewBot|Tcl http client package|http://www.bbbike.org' |
	awk '{print $11}' | perl -npe "s,.?http://www.bbbike.org$url_match\?.*\n,$1,g" | sort | uniq -c | sort -nr

echo ""
echo -n "bbbike cities: "
zcat -f $logfiles | egrep "GET $url_match.*?\?" | egrep -v '" 40[34] ' |
	egrep -v 'imagetype=png.*geometry=240x180' |  
	perl -ne 'print "$1\n" if m,GET /cgi/(.*?).cgi, || m,GET /([A-Z][a-z]+)/\?, || m,GET /([a-z][a-z]/[A-Z][a-z]+)/\?, ' | wc -l

zcat -f $logfiles | egrep "GET $url_match.*?\?" | egrep -v '" 40[34] ' |
	egrep -v 'imagetype=png.*geometry=240x180' |
	perl -ne 'print "$1\n" if m,GET /cgi/(.*?).cgi, || m,GET /([A-Z][a-z]+)/\?, || m,GET /([a-z][a-z]/[A-Z][a-z]+)/\?,' |
	sort | uniq -c | sort -nr


echo ""
echo -n "OpenSearch requests: "
zcat -f $logfiles | egrep 'GET /cgi/api.*?\?' | egrep -v '" 40[34] ' | wc -l

echo "OpenSearch requests per city: "
zcat -f $logfiles | egrep 'GET /cgi/api.*?\?' | egrep -v '" 40[34] ' | perl -ne 'print "$1\n" if /city=([^&\s]+)/' | sort | uniq -c | sort -nr

echo ""
echo -n "street requests: "
zcat -f $logfiles | egrep 'GET /cgi/street-coord.cgi\?' | egrep -v '" 40[34] ' | wc -l


echo ""
echo -n "bbbike cities pdf: "
zcat -f $logfiles | egrep 'POST (/[a-z][a-z])?/[A-Z][a-z]+.*?\?' | egrep -v '" 40[34] ' | perl -ne 'print "$1\n" if m,POST /[A-Z][a-z]+/(.*?), || m,POST /[a-z][a-z]/[A-Z][a-z]+/(.*?),' | wc -l

zcat -f $logfiles | egrep 'POST (/[a-z][a-z])?/[A-Z][a-z]+/.*?\?' | egrep -v '" 40[34] ' | 
	perl -ne 'print "$1\n" if m,POST /([A-Z][a-z]+)/, || m,POST /([a-z][a-z]/[A-Z][a-z]+)/,'|
	sort | uniq -c | sort -nr

echo ""
echo -n "output formats total: "
zcat -f $logfiles | egrep "GET $url_match.*?\?" | egrep -v '" 40[34] ' | 
	perl -ne 'print "$1 $2\n" if m,GET /([^/]+)/.*?\?\S*output_as=([^;&\s]+),' | wc -l
echo "output formats: "
zcat -f $logfiles | egrep "GET $url_match.*?\?" | egrep -v '" 40[34] ' |
	perl -ne 'print "$1 $2\n" if m,GET /([^/]+)/.*?\?\S*output_as=([^;&\s]+),' | sort | uniq -c | sort -nr

echo ""
echo -n "slippymap cities: "
zcat -f $logfiles | egrep "GET $url_match.*?\?" | egrep -v '" 40[34] ' | egrep 'startc=[0-9-]+.*zielc=[0-9-]' | 
	perl -ne 'print "$1\n" if m,GET /([A-Z][a-z]+)/\?, || m,GET /([a-z][a-z]/[A-Z][a-z]+)/\?,' | wc -l
zcat -f $logfiles | egrep "GET $url_match.*?\?" | egrep -v '" 40[34] ' |
	egrep 'startc=[0-9-]+.*zielc=[0-9-]' |
	perl -ne 'print "$1\n" if m,GET /([A-Z][a-z]+)/\?, || m,GET /([a-z][a-z]/[A-Z][a-z]+)/\?,' |
	sort | uniq -c | sort -nr

echo ""
echo -n "slippymap cities IE6/7: "
zcat -f $logfiles | egrep 'POST /cgi/slippymap.*?\?' | egrep -v '" 40[34] ' | perl -ne 'print "$1\n" if m,city=(.*?)[&;],' | wc -l
zcat -f $logfiles | egrep 'POST /cgi/slippymap.*?\?' | egrep -v '" 40[34] ' |
	perl -ne 'print "$1\n" if m,city=(.*?)[&;\s],' | sort | uniq -c | sort -nr

