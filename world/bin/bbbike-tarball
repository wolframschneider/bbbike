#!/bin/sh
# Copyright (c) 2009-2013 Wolfram Schneider, http://bbbike.org
#
# bbbike-tarball - create $HOME/src/bbbike.tgz tarball

set -e

dir=`dirname $0`
case $dir in 
  /* ) ;;
   * ) dir=$(pwd)/$dir;;
esac

PATH=$PATH:$dir; export PATH 
export bbbike_fast_checkout="false"
: ${bbbike_src=$HOME/src/bbbike.tgz}
gzip=`which pigz gzip | head -n 1`

dir=$(mktemp -d -t bbbike-tarball.XXXXXXXX)
cd $dir

error () {
   message="$@"
   echo $message
   exit 2
}

bbbike-checkout >&2 || error "checkout failed: $dir"

make -C./bbbike -s update-files  || error "update-files"
#make -C./bbbike -s js perltidy || error "js perltidy"

mkdir -p $(dirname ${bbbike_src})

tar cf - bbbike | $gzip > ${bbbike_src}.new
mv -f ${bbbike_src}.new ${bbbike_src}
$gzip -t ${bbbike_src}

rm -rf $dir

