#!/bin/sh
# Copyright (c) 2009-2013 Wolfram Schneider, http://bbbike.org
#
# bbbike-checkout - checkout bbbike @ world sources and setup configuration

set -e
make_verbose=-s
git="nice -5 git"
git_clone_opt="-q"
: ${bbbike_macos=false}


if [ ! -x /usr/local/bin/perl ]; then
    echo >&2 "/usr/local/bin/perl does not exists"
    echo >&2 "Please run: ln -s /usr/bin/perl /usr/local/bin/perl"
    echo >&2 "        or: ln -s /opt/local/bin/perl /usr/local/bin/perl"
    exit 1
fi

git_config () {
    git config user.name "Wolfram Schneider"
    git config user.email wosch@freebsd.org
    git config push.default current
}

######################################################################
# main git checkout
#

if $bbbike_macos; then
    git clone $git_clone_opt git@github.com:wolframschneider/bbbike-macos.git
fi

# original github repo
#git clone $git_clone_opt git@github.com:wolframschneider/bbbike.git
# local cache repo
git clone $git_clone_opt ssh://git.bbbike.org/home/git/bbbike

( cd bbbike && git_config )
if $bbbike_macos; then
    ( cd bbbike-macos && git_config )
fi

mkdir -p osm/download

cd bbbike
git_config

# *world is the default branch at github for bbbike@world
#git checkout -b world origin/world
( cd ext; time make all; time make install; echo $: ) > log.ext 2>&1 &

# add remote master from eserte
git remote add eserte git://github.com/eserte/bbbike.git
git fetch eserte

# add remote world from github
git remote add github git@github.com:wolframschneider/bbbike.git
git fetch github


######################################################################
# post configuration
#
echo ""
echo "show branch: "
git branch

echo ""

echo "create symlinks ..."
ln -s world/Makefile.osm
make $make_verbose -f Makefile.osm create-bbbike-web-symlinks java-config

# make ext
wait

echo "you may run as well: make -s update-files"
#echo "                     ( cd ext; make -s all install)"
echo "                     git merge eserte/master"

