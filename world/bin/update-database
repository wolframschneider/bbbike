#!/bin/sh
# Copyright (c) 2009-2012 Wolfram Schneider, http://bbbike.org
#
# wrapper for Makefile bug
#

set -e

tmp=tmp
mkdir -p $tmp

: ${bbbike_build="build-runtime"}
: ${bbbike_download="planet-download"}
: ${bbbike_extract="distclean cities-parallel"}
: ${bbbike_convert="convert-wgs84 convert-post check-data-osm rsync-bg convert-bbbike update-files"}
: ${bbbike_install="rsync-tgz _rsync cache-heater"}
: ${bbbike_post="osm2garmin osm2shape osm-html rsync rsync-osm-full"}

commands="$bbbike_build $bbbike_download $bbbike_extract $bbbike_convert $bbbike_install $bbbike_post"

# lower I/O nice level on linux
if which ionice >/dev/null; then
   ionice=ionice
   ionice_opt="-c 3"
fi

begin="`date`"
for i in $commands
do
	# compress old log files
	if [ -e tmp/log.$i ]; then
		 gzip -f tmp/log.$i
	fi

	case $i in
	    # in background
	    rsync-osm | rsync-bg ) time $ionice $ionice_opt make -s $i > tmp/log.$i 2>&1 & ;;

	    # foreground
	    * )         time $ionice $ionice_opt make -s $i > tmp/log.$i 2>&1 ;;
	esac
done
wait

# set an notice
(  
   echo "hostname: `hostname`"
   echo "begin: $begin"
   echo "end:   `date`" 
) | mail -s "$0/done" `whoami`

