#!/bin/sh
# Copyright (c) 2009-2012 Wolfram Schneider, http://bbbike.org
#
# wrapper for Makefile bug
#

set -e

tmp=tmp
mkdir -p $tmp

: ${bbbike_build="build-runtime"}
: ${bbbike_download="planet-download"}
: ${bbbike_extract="distclean cities-parallel"}
: ${bbbike_convert="convert-wgs84 convert-post convert-bbbike update-files"}

commands="$bbbike_build $bbbike_download $bbbike_extract $bbbike_convert"

# lower I/O nice level on linux
if which ionice >/dev/null; then
   ionice=ionice
   ionice_opt="-c 3"
fi

begin="`date`"
for i in $commands
do
	# compress old log files
	if [ -e tmp/log.$i ]; then
		 gzip -f tmp/log.$i
	fi

	\time $ionice $ionice_opt make -s $i > tmp/log.$i 2>&1
done

# set an notice
(  
   echo "hostname: `hostname`"
   echo "begin: $begin"
   echo "end:   `date`" 
) | mail -s "$0/done" `whoami`

