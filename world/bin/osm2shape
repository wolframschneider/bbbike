#!/bin/sh
# Copyright (c) 2012-2013 Wolfram Schneider, http://bbbike.org
#
# osm2shape  - convert a osm/pbf file to shape
#

PATH=/bin:/usr/bin:/usr/local/bin; export PATH
: ${BBBIKE_EXTRACT_LANG=en}

set -e

usage () {
   echo "$@"
   echo "usage file.pbf"
   exit 1
}

file="$1"
city="$2"

test -e "$file" || usage "file $file does not exists"

: ${debug=false}
pwd=$(pwd)

template=$(dirname $0)/../etc/extract/$(basename $0).$BBBIKE_EXTRACT_LANG.sh
case $template in /*) ;; *) template=$(pwd)/$template ;; esac

test -z "$file" && usage
: ${osm_checksum=`dirname $0`/osm-checksum}
osm_fixme=`dirname $0`/pbf2pbf

tmpdir=`mktemp -d ${TMPDIR-"/bbbike/tmp"}/osmium2shape.XXXXXXXXXXX`

# cleanup after signal, but show errors first
trap '( sleep 1; rm -rf $tmpdir ) &' 1 2 15

shape=`basename "$file" | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
shape_dir=$tmpdir/${shape}-shp
mkdir -p $shape_dir $shape_dir/shape

text2html=$(dirname $0)/text2html.sh
case $text2html in /*) ;; *) text2html=$(pwd)/$text2html ;; esac

logfile=$shape_dir/logfile.txt

if osmium2shape -d $shape_dir/shape $file > $logfile 2>&1; then
   :
else
   exit=$?
   echo "Failed to convert $file"
   cat $logfile
   exit $exit
fi
#rm -f $file_fixme

cd $shape_dir
date=$(date -u)

BBBIKE_EXTRACT_COORDS=$BBBIKE_EXTRACT_COORDS BBBIKE_EXTRACT_URL=$BBBIKE_EXTRACT_URL \
  date=$date city=$city sh $template > README.txt

$text2html < README.txt > README.html

case $BBBIKE_EXTRACT_LANG in
  en ) ext2="" ;;
   * ) ext2=".$BBBIKE_EXTRACT_LANG" ;;
esac

cd ..
shape_zip=`dirname $file`/$shape.osm.shp${ext2}.zip
zip -q -r - -- `basename $shape_dir` | \
  ( cd $pwd;
    cat > $shape_zip.tmp && mv $shape_zip.tmp $shape_zip
    $osm_checksum $shape_zip
  )

$debug || rm -rf $tmpdir

