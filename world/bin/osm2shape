#!/bin/sh
# Copyright (c) 2012-2013 Wolfram Schneider, http://bbbike.org
#
# osm2shape  - convert a osm/pbf file to shape
#

PATH=$HOME/bin:/bin:/usr/bin; export PATH
set -e

usage () {
   echo "$@"
   echo "usage file.pbf"
   exit 1
}

file="$1"
city="$2"

test -e "$file" || usage "file $file does not exists"

: ${debug=false}
pwd=$(pwd)

test -z "$file" && usage
: ${osm_checksum=`dirname $0`/osm-checksum}
osm_fixme=`dirname $0`/pbf2pbf
tmpdir=`mktemp -d ${TMPDIR-"/bbbike/tmp"}/osmium2shape.XXXXXXXXXXX`
shape=`basename "$file" | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
shape_dir=$tmpdir/${shape}-shp
mkdir -p $shape_dir $shape_dir/shape

text2html=$(dirname $0)/text2html.sh
case $text2html in /*) ;; *) text2html=$(pwd)/$text2html ;; esac

logfile=$shape_dir/logfile.txt

if osmium2shape -d $shape_dir/shape $file > $logfile 2>&1; then
   :
else
   exit=$?
   echo "Failed to convert $file"
   cat $logfile
   exit $exit
fi
#rm -f $file_fixme

cd $shape_dir
date=$(date -u)

cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org
Extracts created by BBBike, http://BBBike.org
osmium2shape by Geofabrik, http://geofabrik.de


Please read the OSM wiki how to use shape files.

  http://wiki.openstreetmap.org/wiki/Shapefiles


This shape file was created on: $date
GPS rectangle coordinates (lng,lat): $BBBIKE_EXTRACT_COORDS
Script URL: $BBBIKE_EXTRACT_URL
Name of area: $city

We appreciate any feedback, suggestions and a donation! You can support us via
PayPal, Flattr or bank wire transfer: http://www.BBBike.org/community.html

thanks, Wolfram Schneider

--
http://www.BBBike.org - Your Cycle Route Planner
EOF

$text2html < README.txt > README.html

cd ..
shape_zip=`dirname $file`/$shape.osm.shp.zip
zip -q -r - -- `basename $shape_dir` | \
  ( cd $pwd;
    cat > $shape_zip.tmp && mv $shape_zip.tmp $shape_zip
    $osm_checksum $shape_zip
  )

$debug || rm -rf $tmpdir
