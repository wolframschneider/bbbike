#!/bin/sh
# Copyright (c) 2012 Wolfram Schneider, http://bbbike.org
#
# osm2shape  - convert a osm/pbf file to shape
#

PATH=$HOME/bin:/bin:/usr/bin; export PATH
set -e

usage () {
   echo "$@"
   echo "usage file.pbf"
   exit 1
}

file="$1"
test -e "$file" || usage "file $file does not exists"

: ${debug=false}
pwd=$(pwd)

test -z "$file" && usage
osm_checksum=`dirname $0`/osm-checksum
osm_fixme=`dirname $0`/pbf2pbf
tmpdir=`mktemp -d ${TMPDIR-"/bbbike/tmp"}/osmium2shape.XXXXXXXXXXX`
shape=`basename "$file" | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
shape_dir=$tmpdir/$shape
mkdir -p $shape_dir


logfile=$shape_dir/logfile.txt 

#file_basename=`basename $file`
#file_fixme=$shape_dir/$file_basename
#if osmosis --read-pbf $file --bb left=-180 right=180 top=90 bottom=-90 clipIncompleteEntities=true --write-pbf omitmetadata=true $file_fixme > $logfile 2>&1; then
#   :
#else
#   exit=$?
#   echo "Failed to fix $file"
#   cat $logfile
#   exit $exit
#fi
osm_fixme=true

if $osm_fixme $file && osmium2shape -d $shape_dir $file > $logfile 2>&1; then
   :
else
   exit=$?
   echo "Failed to convert $file"
   cat $logfile
   exit $exit
fi
#rm -f $file_fixme

cd $shape_dir

cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org
Extracts created by BBBike.org
osmium2shape by Geofabrik, http://geofabrik.de

Please read the OSM wiki how to use shape files.

  http://wiki.openstreetmap.org/wiki/Shapefiles


thanks, Wolfram Schneider

--
http://www.BBBike.org - Your Cycle Route Planner
We appreciate any feedback, suggestions and a donation!
EOF

cd ..
shape_zip=`dirname $file`/$shape.osm.shp.zip
zip -q -r - -- $shape | \
  ( cd $pwd;
    cat > $shape_zip.tmp && mv $shape_zip.tmp $shape_zip 
    $osm_checksum $shape_zip
  )

$debug || rm -rf $tmpdir

