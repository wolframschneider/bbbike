#!/bin/sh
# Copyright (c) 2012 Wolfram Schneider, http://bbbike.org
#
# osm2osmand  - convert a .pbf file to osmand .obf
#

PATH=$HOME/bin:/bin:/usr/bin; export PATH

#: ${osmand_home=$HOME/opt/OsmAndMapCreator-0.6.8.2-beta}
: ${osmand_home="$HOME/opt/OsmAndMapCreator-development-2012-07-22"}

set -e

usage () {
   echo "$@"
   echo "usage file.pbf"
   exit 1
}

file=$1
test -e "$file" || usage "file $file does not exists"
osm_checksum=`dirname $0`/osm-checksum

: ${debug=false}
pwd=$(pwd)

test -z "$file" && usage

if [ -e /bbbike/tmpfs ]; then
    _tmp=/bbbike/tmpfs
else
    _tmp=/bbbike/tmp
fi
tmpdir=`mktemp -d ${TMPDIR-"$_tmp"}/osm2obf.XXXXXXXXXXX`
obf=`basename $file | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
obf_dir=$tmpdir/$obf
mkdir -p $obf_dir

etc_dir=`dirname $0`/../etc/OsmAndMapCreator

# absolute path
case $etc_dir in /* ) ;; *) etc_dir=$pwd/$etc_dir ;; esac
case $file in /* ) ;; *) file=$pwd/$file ;; esac

logfile=$obf_dir/logfile.txt 

mkdir $obf_dir/data $obf_dir/data/osm $obf_dir/data/indexes
#file_basename=`basename $file`
#file_fixme=$obf_dir/data/osm/$file_basename
#if osmosis --read-pbf $file --bb left=-180 right=180 top=90 bottom=-90 clipIncompleteEntities=true --write-pbf omitmetadata=true $file_fixme > $logfile 2>&1; then
#   :
#else
#   exit=$?
#   echo "Failed to fix $file"
#   cat $logfile
#   exit $exit
#fi

cd $obf_dir
( cd data/osm; ln -s $file . )

if time java -XX:+UseParallelGC -Xmx2048M -Xmn256M -Djava.util.logging.config.file=$etc_dir/osm2obf-logging.properties -cp $osmand_home/OsmAndMapCreator.jar:$osmand_home/lib/*.jar net.osmand.data.index.IndexBatchCreator $etc_dir/osm2obf.xml > $logfile 2>&1 && ln data/indexes/*.obf .; then
   :
else
   exit=$?
   echo "Failed to convert $file"
   cat $logfile
   rm -rf $tmpdir
   exit $exit
fi

rm -rf data
cp $etc_dir/osm2obf.xml batch.xml


cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org
Extracts created by BBBike.org
OsmAnd by osmand.net, http://code.google.com/p/osmand

Please read the OsmAnd homepage how to use obf files:

  http://osmand.net

thanks, Wolfram Schneider

--
http://www.BBBike.org - Your Cycle Route Planner
We appreciate any feedback, suggestions and a donation!
EOF

cd ..
zip_file=`dirname $file`/$obf.osm.obf.zip
zip -q -r - -- $obf | \
  ( cd $pwd;
    cat > $zip_file.tmp && mv $zip_file.tmp $zip_file 
    $osm_checksum $zip_file
  )

$debug || rm -rf $tmpdir

