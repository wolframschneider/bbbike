#!/bin/sh
# Copyright (c) 2012 Wolfram Schneider, http://bbbike.org
#
# osm2osmand  - convert a .pbf file to osmand .obf
#

PATH=$HOME/bin:/bin:/usr/bin; export PATH

#: ${osmand_home=$HOME/opt/OsmAndMapCreator-0.6.8.2-beta}
: ${osmand_home="$HOME/opt/OsmAndMapCreator-development-2012-07-22"}
: ${java_heap=1G}

java_opt=-Xmx${java_heap} 

set -e

usage () {
   echo "$@"
   echo "usage file.pbf"
   exit 1
}

error () {
    echo "Failed to convert file: $file"
    cat $logfile
    rm -rf $tmpdir
    exit 1
}

file=$1
test -e "$file" || usage "file $file does not exists"
osm_checksum=`dirname $0`/osm-checksum

: ${debug=false}
pwd=$(pwd)

test -z "$file" && usage
size=$(du -ks -L "$file" | awk '{ print $1}')

# use RAM disk if available
if [ -e /bbbike/tmpfs ]; then
    _tmp=/bbbike/tmpfs
else
    _tmp=/bbbike/tmp
fi
tmpdir=`mktemp -d ${TMPDIR-"$_tmp"}/osm2obf.XXXXXXXXXXX`
obf=`basename $file | perl -npe 's/\.osm(\.pbf|\.gz|\.bz2)?$//'`
obf_dir=$tmpdir/$obf
mkdir -p $obf_dir

etc_dir=`dirname $0`/../etc/OsmAndMapCreator

# absolute path
case $etc_dir in /* ) ;; *) etc_dir=$pwd/$etc_dir ;; esac
case $file in /* ) ;; *) file=$pwd/$file ;; esac

logfile=$obf_dir/logfile.txt 

mkdir $obf_dir/data $obf_dir/data/osm $obf_dir/data/indexes

cd $obf_dir
counter=0
if [ $size -le 5000 ]; then
    ( cd data/osm; ln -s $file . )
else
   # file to large
   split_dir=data/osm
   mapid=93240001
   echo ">>> Run splitter" >> $logfile
   java $java_opt -jar $HOME/opt/splitter/splitter.jar --output-dir=$split_dir  --max-nodes=400000 --mapid=$mapid $file >> $logfile 2>&1 || error

   cwd=$(pwd)
   cd $split_dir
   prefix=`basename $file .osm.pbf`
   for i in *.osm.pbf
   do
      mkdir -p $counter/data/osm $counter/data/indexes
      ln $i $counter/data/osm
      mv -f $i $prefix$(echo $i | perl -npe 's/.{5}/-/') 
      
      counter=`expr $counter + 1`
   done
   cd $cwd;
   
   $debug && ls -l $split_dir
fi
counter=0

if [ $counter -eq 0 ]; then
    time java $java_opt -Xmn256M -Djava.util.logging.config.file=$etc_dir/osm2obf-logging.properties -cp $osmand_home/OsmAndMapCreator.jar:$osmand_home/lib/*.jar net.osmand.data.index.IndexBatchCreator $etc_dir/osm2obf.xml > $logfile 2>&1 && ln data/indexes/*.obf .
    exit=$?
fi

if [ $exit -ne 0 ];then
   echo "Failed to convert $file"
   cat $logfile
   exit $exit
fi

rm -rf data
cp $etc_dir/osm2obf.xml batch.xml


cat << EOF > README.txt
Map data (c) OpenStreetMap contributors, http://www.openstreetmap.org
Extracts created by BBBike.org
OsmAnd by osmand.net, http://code.google.com/p/osmand

Please read the OsmAnd homepage how to use obf files:

  http://osmand.net

thanks, Wolfram Schneider

--
http://www.BBBike.org - Your Cycle Route Planner
We appreciate any feedback, suggestions and a donation!
EOF

cd ..
zip_file=`dirname $file`/$obf.osm.obf.zip
zip -q -r - -- $obf | \
  ( cd $pwd;
    cat > $zip_file.tmp && mv $zip_file.tmp $zip_file 
    $osm_checksum $zip_file
  )

$debug || rm -rf $tmpdir

