# lighttpd configuration file
#
# use it as a base for lighttpd 1.0.0 and above
#
# $Id: www.freebsd.de.conf,v 1.3 2007/04/19 07:50:08 wosch Exp $

############ Options you really have to take care of ####################
# all sites
#
index-file.names     = ( "index.html", "index.cgi" )
cgi.assign           = ( ".cgi" => "" )
dir-listing.activate = "disable"

compress.cache-dir          = "/var/cache/lighttpd/compress/"
compress.filetype           = ("text/plain", "text/html", "text/javascript", "application/javascript", "text/css")


######################################################################
# main config
#
$HTTP["host"] =~ "^(www\.bbbike\.org)$" {
  	server.document-root 	= "/usr/local/www/bbbike.org/world/web"
	accesslog.filename      = "/var/log/lighttpd/bbbike.log"
	server.breakagelog         = "/var/log/lighttpd/bbbike.error.log"
	compress.cache-dir      = "/var/cache/lighttpd/www.bbbike.org/"

	# block rough robots by IP address
	# $HTTP["remoteip"] =~ "^174\.127\.132\.|^80\.177\.25\.|^79\.142\.|^79\.125\.|^94\.100\.|^67.202\.|^75\.101\.|^213\.5\.|^174\.129\.|^77\.121\.|^184\.72\.|^85\.17\.|^91\.201\.6[4567]|^188\.138\.56\.70|^91\.201\.66|^94\.100\.25|^50\.18\.49|^204\.236\.254|^46\.51\.|^62\.99\.204\.|^91\.224\.160\." {
	$HTTP["remoteip"] =~ "^91\.207\.5\." {
      	   url.access-deny = ( "" )
 	}

	# block rough robots by referer
	$HTTP["referer"] =~ "[a-z]/bbbike\.org|[a-z]/cyclerouteplanner\.org|[a-z]/cycleroute\.net|[a-z]/www\.bbbike\.org|[a-z]/www\.cyclerouteplanner\.org|[a-z]/www\.cycleroute\.net" {
      	   url.access-deny = ( "" )
 	}

	# block rough robots by URL + IP address
	$HTTP["url"] =~ "^/[a-z][a-z]/" {
	   $HTTP["remoteip"] =~ "^93\.158\.145|^119\.63\.192|^38\.101\.148|^94\.23\.225\.|^109\.73\.78\.|^50\.19\.|^107\.22\.|^176\.31\." {
      	      url.access-deny = ( "" )
	   }
  	}

        # broken user agent
	#$HTTP["useragent"] == "Opera/9.80 (Windows NT 5.1; U; de) Presto/2.5.22 Version/10.51" {
        #    $HTTP["url"] !~ "^/cgi/Dresden.cgi\?start=Dieselstr\.\+" {
        #    	url.access-deny = ( "" )
        #    }
  	#}

	# stale links
    	url.redirect = ( 
		"^/cgi/([A-Z]+[a-z].*?)(\.en)?\.cgi(.*)" => "http://www.bbbike.org/$1/$3",
    		"/([A-Z][a-zA-Z]+)/index.en.cgi" => "http://www.bbbike.org/$1/",
    		"/([A-Z][a-zA-Z]+)/index.cgi$" => "http://www.bbbike.org/$1/",
    		"/index.de.html" => "http://www.bbbike.org/de/",
    		"/San_Francisco" => "http://www.bbbike.org/SanFrancisco"
	)

	# /streets.html mapping
	$HTTP["request-method"] == "GET" {
            url.rewrite-once = ( "^/([a-z][a-z]/|m/)?([A-Z][A-Za-z]+)/streets.html$" => "/$1$2/index.cgi?all=2" )
	}

    	$HTTP["url"] =~ "^/images/" { expire.url = ( "" => "access plus 2 hours" ) }
    	$HTTP["url"] =~ "^/html/"   { expire.url = ( "" => "access plus 2 hours" ) }
}

######################################################################
# redirects for old URLs
#
$HTTP["host"] =~ "^(bbbike\.org|www\.cyclerouteplanner\.org|cyclerouteplanner\.org|cycleroute\.net|www\.cycleroute.net)$" {
    	accesslog.filename        = "/var/log/lighttpd/bbbike.log"
    	url.redirect = ( "^/(.*)" => "http://www.bbbike.org/$1" ) 
}

# stale hostnames
$HTTP["host"] =~ "^(bbbike\.elsif\.de|recv\.de|www\.recv\.de)$" {
    	accesslog.filename        = "/var/log/lighttpd/bbbike.log"
    	url.redirect = ( "^/(.*)" => "http://www.bbbike.org/" ) 
}

######################################################################
# main development site
#
$HTTP["host"] =~ "^(dev\.bbbike\.org)$" {
  	server.document-root 	= "/home/wosch/projects/bbbike/world/web"
	accesslog.filename      = "/var/log/lighttpd/dev.bbbike.log"
	#server.breakagelog         = "/var/log/lighttpd/dev.bbbike.error.log"
	compress.cache-dir      = "/var/cache/lighttpd/dev.bbbike.org/"


	alias.url = ( "/robots.txt" => "/home/wosch/projects/bbbike/world/web/robots-dev.txt")


	$HTTP["request-method"] == "GET" {
            url.rewrite-once = ( "^/([a-z][a-z]/|m/)?([A-Z][A-Za-z]+)/streets.html$" => "/$1$2/index.cgi?all=2" )
	}

    	$HTTP["url"] =~ "^/images/" { expire.url = ( "" => "access plus 2 hours" ) }
    	$HTTP["url"] =~ "^/html/"   { expire.url = ( "" => "access plus 2 hours" ) }

}

######################################################################
# second development site
#
$HTTP["host"] =~ "^(devel\.bbbike\.org)$" {
  	server.document-root 	= "/home/wosch/projects/bbbike-devel/world/web"
	accesslog.filename      = "/var/log/lighttpd/devel.bbbike.log"
	#server.breakagelog         = "/var/log/lighttpd/devel.bbbike.error.log"
	compress.cache-dir      = "/var/cache/lighttpd/devel.bbbike.org/"

	alias.url = ( "/robots.txt" => "/home/wosch/projects/bbbike-devel/world/web/robots-dev.txt" )
        url.rewrite-once = ( "^/([a-z][a-z]/|m/)?([A-Z][A-Za-z]+)/streets.html$" => "/$1$2/index.cgi?all=2" )
}

######################################################################
#  mobile phone version
#
$HTTP["host"] =~ "^(m\.bbbike\.org)$" {
  	server.document-root 	= "/usr/local/www/bbbike.org/world/web"
	accesslog.filename      = "/var/log/lighttpd/m.bbbike.log"

	alias.url = ( "/robots.txt" => "/usr/local/www/bbbike.org/world/web/robots-dev.txt" )
	$HTTP["url"] !~ "^/robots.txt$" {
    		url.redirect = ( "^/(.*)" => "http://www.bbbike.org/m/$1" ) 
  	}

	index-file.names           = ( "index.m.html", "index.html", "index.cgi" )
}

######################################################################
# download area
#
$HTTP["host"] =~ "^(download\.bbbike\.org)$" {
    server.document-root = "/usr/local/www/download.bbbike.org"
    accesslog.filename   = "/var/log/lighttpd/download.bbbike.log"
  
    dir-listing.show-readme = "enable"
    dir-listing.activate = "enable"
    dir-listing.hide-dotfiles = "enable"

    url.redirect = ( "^/osm/planet(.*)" => "http://download2.bbbike.org/osm/planet$1" ) 

    $HTTP["url"] =~ "\.(md5|gz|pbf)$" {
    	$HTTP["useragent"] =~ "Purebot/|bingbot/|Ezooms/|ichiro/mobile" {
	    url.access-deny = ( "" )
	}
    }

    mimetype.assign = (
	".poly"	=> "text/x-poly",
	".osm"	=> "application/x-openstreetmap+xml",
	".pbf"	=> "application/x-pbf",
	".osm.gz"	=> "application/x-openstreetmap+xml",
	".osm.bz2"	=> "application/x-openstreetmap+xml",

	".md5"	=> "text/plain",
	".txt" => "text/plain",
	".html" => "text/html"
    )
}

######################################################################
# test site
#
$HTTP["host"] =~ "^localhost$" {
  	server.document-root 	= "/home/wosch/projects/bbbike/world/web"
	accesslog.filename      = "/var/log/lighttpd/localhost.bbbike.log"
	compress.cache-dir      = "/var/cache/lighttpd/localhost.bbbike.org/"

	alias.url = ( 
		"/bbbike/data" => "/home/wosch/projects/bbbike/data",
		"/bbbike" => "/home/wosch/projects/bbbike/world/web",
	)
}


######################################################################
# statistics
#
$HTTP["remoteip"] == "10.0.0.0/8" { status.status-url = "/server-status" }
$HTTP["remoteip"] == "127.0.0.1"  { status.status-url = "/server-status" }

$HTTP["host"] =~ "^(127\.0\.0\.1|10\.0\.0\.[0-9]+)$" {
    accesslog.filename      = "/var/log/lighttpd/server-status.log"
}

# EOF

