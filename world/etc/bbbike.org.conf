# lighttpd configuration file
#
# use it as a base for lighttpd 1.0.0 and above
#
# $Id: www.freebsd.de.conf,v 1.3 2007/04/19 07:50:08 wosch Exp $

############ Options you really have to take care of ####################
# all sites
#
index-file.names     = ( "index.html", "index.cgi" )
cgi.assign           = ( ".cgi" => "" )
dir-listing.activate = "disable"

######################################################################
# main config
#
$HTTP["host"] =~ "^(www\.bbbike\.org)$" {
  	server.document-root 	= "/usr/local/www/bbbike.org/world/web"
	accesslog.filename      = "/var/log/lighttpd/bbbike.log"
	server.errorlog         = "/var/log/lighttpd/bbbike.error.log"

	# block rough robots
	$HTTP["remoteip"] =~ "^174\.127\.132\.|^80\.177\.25\.|^79\.142\.|^79\.125\.|^94\.100\.|^67.202\.|^75\.101\.|^213\.5\.|^174\.129\.|^77\.121\.|^184\.72\.|^85\.17\.|^91\.201\.6[4567]|^188\.138\.56\.70|^91\.201\.66|^94\.100\.25|^50\.18\.49|^204\.236\.254|^46\.51\." {
      	   url.access-deny = ( "" )
 	}

	$HTTP["referer"] =~ "[a-z]/bbbike\.org|[a-z]/cyclerouteplanner\.org|[a-z]/cycleroute\.net|[a-z]/www\.bbbike\.org|[a-z]/www\.cyclerouteplanner\.org|[a-z]/www\.cycleroute\.net" {
      	   url.access-deny = ( "" )
 	}

	$HTTP["url"] =~ "^/[a-z][a-z]/" {
	   $HTTP["remoteip"] =~ "^93\.158\.145|119\.63\.192|^38\.101\.148" {
      	      url.access-deny = ( "" )
	   }
  	}

	# stale links
    	url.redirect = ( 
		"^/cgi/([A-Z]+[a-z].*?)(\.en)?\.cgi(.*)" => "http://www.bbbike.org/$1/$3",
    		"/([A-Z][a-zA-Z]+)/index.en.cgi" => "http://www.bbbike.org/$1/",
    		"/([A-Z][a-zA-Z]+)/index.cgi$" => "http://www.bbbike.org/$1/",
    		"/index.de.html" => "http://www.bbbike.org/de/",
    		"/San_Francisco" => "http://www.bbbike.org/SanFrancisco"
	)

        url.rewrite-once = ( "^/([a-z][a-z]/|m/)?([A-Z][A-Za-z]+)/streets.html$" => "/$1$2/index.cgi/streets.html" )

        # broken user agent
	#$HTTP["useragent"] == "Opera/9.80 (Windows NT 5.1; U; de) Presto/2.5.22 Version/10.51" {
        #    $HTTP["url"] !~ "^/cgi/Dresden.cgi\?start=Dieselstr\.\+" {
        #    	url.access-deny = ( "" )
        #    }
  	#}
}

######################################################################
# redirects for old URLs
#
$HTTP["host"] =~ "^(bbbike\.org|www\.cyclerouteplanner\.org|cyclerouteplanner\.org|cycleroute\.net|www\.cycleroute.net)$" {
    	accesslog.filename        = "/var/log/lighttpd/bbbike.log"
    	url.redirect = ( "^/(.*)" => "http://www.bbbike.org/$1" ) 
}

# stale hostnames
$HTTP["host"] =~ "^(bbbike\.elsif\.de|recv\.de|www\.recv\.de)$" {
    	accesslog.filename        = "/var/log/lighttpd/bbbike.log"
    	url.redirect = ( "^/(.*)" => "http://www.bbbike.org/" ) 
}

######################################################################
# main development site
#
$HTTP["host"] =~ "^(dev\.bbbike\.org)$" {
  	server.document-root 	= "/home/wosch/projects/bbbike/world/web"
	accesslog.filename      = "/var/log/lighttpd/dev.bbbike.log"

	alias.url = ( "/robots.txt" => "/home/wosch/projects/bbbike/world/web/robots-dev.txt" )
    	url.redirect = ( "^/cgi/([A-Z]+[a-z].*?)(\.en)?\.cgi(.*)" => "http://dev.bbbike.org/$1/$3" ) 

        url.rewrite-once = ( "^/([a-z][a-z]/|m/)?([A-Z][A-Za-z]+)/streets.html$" => "/$1$2/index.cgi/streets.html" )
}

######################################################################
# second development site
#
$HTTP["host"] =~ "^(devel\.bbbike\.org)$" {
  	server.document-root 	= "/home/wosch/projects/bbbike-devel/world/web"
	accesslog.filename      = "/var/log/lighttpd/devel.bbbike.log"

	alias.url = ( "/robots.txt" => "/home/wosch/projects/bbbike-devel/world/web/robots-dev.txt" )
    	url.redirect = ( "^/cgi/([A-Z]+[a-z].*?)(\.en)?\.cgi(.*)" => "http://devel.bbbike.org/$1/$3" ) 

        url.rewrite-once = ( "^/([a-z][a-z]/|m/)?([A-Z][A-Za-z]+)/streets.html$" => "/$1$2/index.cgi/streets.html" )
}

######################################################################
#  mobile phone version
#
$HTTP["host"] =~ "^(m\.bbbike\.org)$" {
  	server.document-root 	= "/usr/local/www/bbbike.org/world/web"
	accesslog.filename      = "/var/log/lighttpd/m.bbbike.log"

	alias.url = ( "/robots.txt" => "/usr/local/www/bbbike.org/world/web/robots-dev.txt" )
	$HTTP["url"] !~ "^/robots.txt$" {
    		url.redirect = ( "^/(.*)" => "http://www.bbbike.org/m/$1" ) 
  	}

	index-file.names           = ( "index.m.html", "index.html", "index.cgi" )
}

######################################################################
# download area
#
$HTTP["host"] =~ "^(download\.bbbike\.org)$" {
  	server.document-root 	= "/usr/local/www/download.bbbike.org"
	accesslog.filename      = "/var/log/lighttpd/download.bbbike.log"
}

###

