#!/usr/bin/perl -w
# -*- cperl -*-

#
# Author: Slaven Rezic
#

use strict;
use FindBin;
use lib ("$FindBin::RealBin/..", "$FindBin::RealBin/../lib");

use File::Temp qw(tempfile);
use Test::More 'no_plan';

use Route;

{
    # Taken from kreisfahrt_2007.bbr
    my $sample_bbr_string = <<'EOF';
#BBBike route
$realcoords_ref = [[8515,12242],[8610,12254],[8804,12280],[9028,12307],[9141,12320],[9349,12344],[9359,12252],[9365,12196],[9377,12091],[9386,11995],[9396,11899],[9410,11803],[9425,11702],[9437,11616],[9449,11512],[9461,11412],[9473,11316],[9480,11207],[9615,11225],[9745,11243],[10012,11256],[10244,11160],[10487,11057],[10673,10975],[10777,10930],[10792,10923],[10824,10909],[10847,10853],[10906,10874],[10965,10851],[11039,10820],[11151,10781],[11232,10745],[11269,10731],[11468,10652],[11370,10398],[11454,10400],[11660,10402],[11949,10414],[12213,10434],[12274,10436],[12328,10442],[12401,10461],[12545,10496],[12755,10552],[12899,10595],[12980,10575],[13035,10635],[13082,10634],[13178,10623],[13206,10651],[13305,10789],[13332,10832],[13409,11004],[13454,11119],[13476,11174],[13546,11352],[13594,11489],[13601,11518],[13655,11727],[13702,11918],[13749,12114],[13792,12292],[13885,12279],[14208,12235],[14230,12312],[14272,12446],[14304,12552],[14326,12627],[14363,12749],[14336,12758],[14096,12827],[13960,12866],[13844,12900],[13895,13017],[13930,13100],[13992,13240],[14056,13386],[14109,13449],[14053,13620],[14011,13750],[13862,13688],[13708,13623],[13640,13597],[13550,13560],[13334,13459],[13228,13615],[13225,13620],[13166,13707],[13100,13803],[13037,13897],[12975,13990],[12912,14084],[12729,14227],[12630,14306],[12429,14462],[12338,14532],[12128,14640],[12040,14688],[11990,14714],[11879,14771],[11712,14868],[11776,15060],[11798,15133],[11822,15193],[11852,15281],[11688,15398],[11603,15455],[11502,15527],[11418,15587],[11301,15668],[11192,15721],[11093,15771],[10963,15789],[10972,15895],[10977,15944],[10987,16008],[10994,16120],[11003,16196],[11013,16278],[11018,16358],[11033,16464],[10765,16486],[10699,16492],[10620,16497],[10533,16505],[10458,16509],[10370,16516],[10282,16522],[10197,16528],[9998,16547],[9883,16557],[9816,16565],[9514,16603],[9455,16609],[9331,16624],[9210,16638],[8939,16668],[8759,16684],[8721,16689],[8503,16716],[8467,16718],[8260,16740],[8196,16746],[7862,16773],[7687,16761],[7606,16746],[7456,16620],[7403,16575],[7231,16418],[7051,16264],[6965,16190],[6790,16018],[6914,15908],[6957,15869],[7043,15793],[7129,15717],[7198,15656],[7277,15586],[7148,15447],[7020,15314],[6846,15202],[6737,15133],[6630,15100],[6528,15000],[6445,14893],[6334,14756],[6314,14659],[6255,14310],[6252,14249],[6248,14185],[6242,13953],[6242,13928],[6252,13600],[6249,13513],[6249,13322],[6229,13209],[5975,13256],[5876,13209],[5762,13155],[5689,13121],[5636,13098],[5472,13056],[5328,13019],[5316,12928],[5298,12910],[5287,12900],[5244,12864],[5249,12825],[5081,12458],[5018,12322],[4999,12289],[4981,12252],[4932,12132],[4859,11980],[4867,11835],[4770,11820],[4747,11751],[4780,11702],[4842,11679],[4892,11621],[4917,11592],[5085,11413],[5091,11406],[5166,11343],[5268,11274],[5459,11135],[5542,11075],[5505,10971],[5484,10810],[5657,10868],[5725,10892],[5797,10881],[5942,10803],[6040,10751],[6137,10689],[6234,10629],[6353,10583],[6494,10539],[6536,10520],[6636,10485],[6753,10446],[6931,10391],[7037,10359],[7245,10297],[7413,10244],[7579,10183],[7539,9970],[7526,9782],[7520,9572],[7517,9454],[7478,9340],[7381,9165],[7315,9038],[7275,8960],[7320,8939],[7360,8918],[7497,8916],[7548,8879],[7570,8863],[7642,8815],[7709,8770],[7713,8600],[7712,8560],[7716,8356],[7716,8048],[7717,7759]];$search_route_points_ref = [['8515,12242','m'],['9349,12344','a'],['9480,11207','a'],['11468,10652','a'],['11370,10398','a'],['13206,10651','a'],['13792,12292','a'],['14208,12235','a'],['14363,12749','a'],['13844,12900','a'],['14109,13449','a'],['14011,13750','a'],['13334,13459','a'],['11712,14868','a'],['11852,15281','a'],['10963,15789','a'],['11033,16464','a'],['8260,16740','a'],['6790,16018','a'],['7277,15586','a'],['6334,14756','a'],['6252,13600','a'],['6229,13209','a'],['5328,13019','a'],['4867,11835','a'],['5542,11075','a'],['5725,10892','a'],['7579,10183','a'],['7275,8960','a'],['7709,8770','a'],['7717,7759','a']];
EOF
    my($tmpfh, $sample_bbr_file) = tempfile(UNLINK => 1, SUFFIX => '_route_t.bbr')
	or die "Can't create temporary file: $!";
    print $tmpfh $sample_bbr_string;
    close $tmpfh
	or die $!;

    my $route = Route->load_as_object($sample_bbr_file);
    isa_ok $route, 'Route';
    is_deeply $route->path->[0], [8515,12242], 'first coordinate in route';
    is_deeply $route->path->[-1], [7717,7759], 'last coordinate in route';

    ok $route->_searchroutepoints, 'searchroutepoints filled';

    my($tmp2fh, $tmp2file) = tempfile(UNLINK => 1, SUFFIX => '_route_t.bbr')
	or die "Can't create temporary file: $!";
    $route->save_object($tmp2file);

    my $route2 = Route->load_as_object($tmp2file);
    is_deeply $route2, $route, 'roundtrip';
}

{
    my $r = Route->new_from_realcoords([[0,0],[500,0],[1000,0]]);
    is $r->from, '0,0';
    is $r->to, '1000,0';
    is $r->len, 1000; # XXX accuracy?
    is_deeply $r->path, [[0,0],[500,0],[1000,0]];
    is_deeply [$r->path_list], [[0,0],[500,0],[1000,0]];
    is_deeply $r->path_s, ["0,0","500,0","1000,0"];
    is_deeply [$r->path_s_list], ["0,0","500,0","1000,0"];
    ok !$r->is_empty;
    { local $TODO = "Should be zero, not undef"; is $r->trafficlights, 0; }
    is $r->as_string, "0,0;500,0;1000,0";
    is $r->as_cgi_string, "0,0!500,0!1000,0";

    $r->add(2000,0);
    is $r->to, '2000,0';
    is $r->len, 2000;
    is $r->as_string, "0,0;500,0;1000,0;2000,0";

    $r->rueckweg;
    is $r->from, '2000,0';
    is $r->to, '0,0';
    is $r->len, 2000;
    is $r->trafficlights, 0;
    is $r->as_string, "2000,0;1000,0;500,0;0,0";

    $r->prepend(3000,0);
    is $r->from, '3000,0';
    is $r->len, 3000;
    is $r->trafficlights, 0;
    is $r->as_string, "3000,0;2000,0;1000,0;500,0;0,0";
}

__END__
