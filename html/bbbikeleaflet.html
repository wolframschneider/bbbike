<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"> <!-- -*-html-*- -->
<html>
 <head>
 <title>BBBike &amp; Leaflet</title>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <style>
  body {
    padding: 0;
    margin: 0;
  }
  html, body, #map {
    height: 100%;
  }
 </style>

 <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

 <!-- Leaflet -->
 <link rel="stylesheet" href="http://bbbike.de/leaflet/dist/leaflet.css" />
 <!--[if lte IE 8]><link rel="stylesheet" href="http://bbbike.de/leaflet/dist/leaflet.ie.css" /><![endif]-->
 <script src="http://bbbike.de/leaflet/dist/leaflet.js"></script>
 <script src="HTTPQuery.js"></script><!-- FIX URL LAYOUT -->
 <script>
  var initialRouteGeojson = null;
  // magic comment for bbbikeleaflet.cgi following, do not change
  //--- INSERT GEOJSON HERE ---

  // URL layout, lang detection
  var thisURL = location.href;
  var lang = "de";
  if (thisURL.match(/bbbikeleaflet\.en\./)) {
    lang = "en";
    thisURL = thisURL.replace(/bbbikeleaflet\.en\./, "bbbikeleaflet.");
  }
  var useOldURLLayout = thisURL.match(/(cgi\/bbbikeleaflet|bbbike\/html\/bbbikeleaflet)/);
  var bbbikeRoot, cgiURL, bbbikeImagesRoot;
  if (useOldURLLayout) {
    bbbikeRoot = thisURL.replace(/\/(cgi|html)\/bbbikeleaflet\..*/, "");
    bbbikeImagesRoot = bbbikeRoot + "/images";
    cgiURL     = bbbikeRoot + "/cgi/bbbike.cgi";
  } else {
    bbbikeRoot = thisURL.replace(/\/(cgi-bin|BBBike\/html)\/bbbikeleaflet\..*/, "");
    bbbikeImagesRoot = bbbikeRoot + "/BBBike/images";
    cgiURL     = bbbikeRoot + "/cgi-bin/bbbike.cgi";
  }

  var q = new HTTP.Query;
  if (q.get("lang") == "de") {
    lang = "de";
  } else if (q.get("lang") == "en") {
    lang = "en";
  }

  // localization
  var msg = {"en":{"Kartendaten":"Map data",
		   "Qualit\u00e4t":"Smoothness"
                  }};
  function M(string) {
    if (msg[lang] && msg[lang][string]) {
      return msg[lang][string];
    } else {
      return string;
    }
  }  	    

  // icons and markers
  var startIconOptions = {
    iconUrl: bbbikeImagesRoot + "/flag2_bl_centered.png",
    shadowUrl: bbbikeImagesRoot + "/flag_shadow.png",
    iconSize: new L.Point(32,32),
    shadowSize: new L.Point(45,24),
    iconAnchor: new L.Point(16,16)
  };
  var startIconClass = L.Icon.extend(L.VERSION >= 0.4 ? {options:startIconOptions} : startIconOptions);
  var startIcon = new startIconClass();

  var goalIconOptions = {
    iconUrl: bbbikeImagesRoot + "/flag_ziel_centered.png",
    shadowUrl: bbbikeImagesRoot + "/flag_shadow.png",
    iconSize: new L.Point(32,32),
    shadowSize: new L.Point(45,24),
    iconAnchor: new L.Point(16,16)
  };
  var goalIconClass = L.Icon.extend(L.VERSION >= 0.4 ? {options:goalIconOptions} : goalIconOptions);
  var goalIcon = new goalIconClass();

  var loadingIconOptions = {
    iconUrl: bbbikeImagesRoot + "/loading.gif",
    shadowUrl: bbbikeImagesRoot + "/px_1t.gif",
    iconSize: new L.Point(16,16),
    shadowSize: new L.Point(1,1),
    iconAnchor: new L.Point(0,0)
  };
  var loadingIconClass = L.Icon.extend(L.VERSION >= 0.4 ? {options:loadingIconOptions} : loadingIconOptions);
  var loadingIcon = new loadingIconClass();

  var startMarker, goalMarker, loadingMarker;

  // globals
  var routeLayer;
  var searchState = "start";
  var startLatLng;
  var map;

  var base_map_url_mapping = { 'stable':'http://{s}.tile.bbbike.org/osm/mapnik-german' // will be mapnik-german-srt some day
                              ,'devel1':'http://z.tile.bbbike.org/osm/mapnik-german'
                              ,'devel2':'http://z.tile.bbbike.org/osm/mapnik-german-srt'
                              ,'mapnik-bbbike':'http://z.tile.bbbike.org/osm/mapnik-german-srt' // will point to non-z some day
                              ,'mapnik-osm':'http://{s}.tile.bbbike.org/osm/mapnik'
                              ,'mapnik-german':'http://tile.bbbike.org/osm/mapnik-german'
                             };
  var smoothness_map_url_mapping = { 'stable':'http://{s}.tile.bbbike.org/osm/bbbike-smoothness'
                                    ,'devel1':'http://z.tile.bbbike.org/osm/bbbike-smoothness'
                                    ,'devel2':'http://z.tile.bbbike.org/osm/bbbike-smoothness'
                                    ,'mapnik-bbbike':'http://z.tile.bbbike.org/osm/bbbike-smoothness' // will point to non-z some day
                                    ,'mapnik-osm':'http://{s}.tile.bbbike.org/osm/bbbike-smoothness'
                                    ,'mapnik-german':'http://{s}.tile.bbbike.org/osm/bbbike-smoothness'
                                   };

  var mapset = q.get('mapset') || 'stable';
  var base_map_url = base_map_url_mapping[mapset] || base_map_url_mapping['stable'];
  var smoothness_map_url = smoothness_map_url_mapping[mapset] || smoothness_map_url_mapping['stable'];

  function doLeaflet() {
    var bbbikeOrgMapnikGermanUrl = base_map_url + '/{z}/{x}/{y}.png',
        bbbikeAttribution = M("Kartendaten") + ' \u00a9 2012 <a href="http://bbbike.de">Slaven ReziÄ‡</a>',
        bbbikeTileLayer = new L.TileLayer(bbbikeOrgMapnikGermanUrl, {maxZoom: 18, attribution: bbbikeAttribution});

    var bbbikeOrgSmoothnessUrl = smoothness_map_url + '/{z}/{x}/{y}.png',
        bbbikeSmoothnessTileLayer = new L.TileLayer(bbbikeOrgSmoothnessUrl, {maxZoom: 18, attribution: bbbikeAttribution});

    var osmMapnikUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
	osmAttribution = M("Kartendaten") + ' \u00a9 2012 <a href="http://www.openstreetmap.org/">OpenStreetMap</a> Contributors',
	osmTileLayer = new L.TileLayer(osmMapnikUrl, {maxZoom: 18, attribution: osmAttribution});
    
    map = new L.Map('map',
		    {
		     zoomAnimation:false, fadeAnimation:false, // animations may be super-slow, seen on mosor/firefox9
		     doubleClickZoom:false, // used for setting start/goal, see below for click/dblclick event
		     layers: [bbbikeTileLayer]
		    }
		   );

    var baseMaps = { "BBBike":bbbikeTileLayer, "OSM":osmTileLayer };
    var overlayMaps = {};
    overlayMaps[M("Qualit\u00e4t")] = bbbikeSmoothnessTileLayer;

    var layersControl = new L.Control.Layers(baseMaps, overlayMaps);
    map.addControl(layersControl);

    map.addLayer(bbbikeTileLayer);

    routeLayer = new L.GeoJSON();
    map.addLayer(routeLayer);
    layersControl.addOverlay(routeLayer, "Route");

    map.on(//'click', //XXX has bugs, may fire on simple zooming
           'dblclick', function(e) {
      if (searchState == "start") {
        startLatLng = e.latlng;

        if (goalMarker) {
	  map.removeLayer(goalMarker);
        }
        setStartMarker(startLatLng);

        searchState = 'goal';
      } else if (searchState == "goal") {
        setGoalMarker(e.latlng);

        searchRoute(startLatLng, e.latlng);
      } else if (searchState == "searching") {
        // nop
      }
    });

    var zoom = q.get("zoom");
    if (!zoom) { zoom = 13 }
    if (initialRouteGeojson) {
      showRoute(initialRouteGeojson);
      map.setView(L.GeoJSON.coordsToLatLng(initialRouteGeojson.geometry.coordinates[0]), zoom);
    } else {
      var lat = q.get("lat");
      var lon = q.get("lon");
      if (lat && lon) {
        map.setView(new L.LatLng(lat, lon), zoom);
      } else {
        lat = q.get("mlat");
        lon = q.get("mlon");
        if (lat && lon) {
          var center = new L.LatLng(lat, lon);
          map.setView(center, zoom);
          setStartMarker(center);
        } else {
          map.setView(new L.LatLng(52.516224, 13.377463), zoom); // Brandenburger Tor
        }
      }
    }
  }

  function getSearchCoordParams(startPoint, goalPoint) {
    return "startc_wgs84=" + startPoint.lng + "," + startPoint.lat + ";zielc_wgs84=" + goalPoint.lng + "," + goalPoint.lat;
  }

//XXX do not hardcode!
  var commonSearchParams = ";pref_seen=1;pref_speed=20;pref_cat=;pref_quality=;pref_green=;scope=;referer=bbbikeleaflet;output_as=geojson";

  function searchRoute(startPoint, goalPoint) {
    searchState = 'searching';
    var searchCoordParams = getSearchCoordParams(startPoint, goalPoint);
    var requestLine = cgiURL + "?" + searchCoordParams + commonSearchParams;
    var routeRequest = new XMLHttpRequest();
    routeRequest.open("GET", requestLine, true);
    setLoadingMarker(goalPoint);
    routeRequest.onreadystatechange = function() {
        showRouteResult(routeRequest);
    };
    routeRequest.send(null);
  }

  function showRouteResult(request) {
    if (request.readyState == 4) {
      if (request.status != 200) {
        alert("Error calculating route: " + request.statusText  + " (status=" + request.status + ")");
      } else {
        var geojson;
        var json = "geojson = " + request.responseText;
        eval(json);
        showRoute(geojson);
      }
      map.removeLayer(loadingMarker);
      searchState = 'start';
    }
  }

  function showRoute(geojson) {
    routeLayer.clearLayers();
    routeLayer.addGeoJSON(geojson);
    var coordinatesLength = geojson.geometry.coordinates.length;
    if (coordinatesLength) {
      setStartMarker(L.GeoJSON.coordsToLatLng(geojson.geometry.coordinates[0]));
      setGoalMarker (L.GeoJSON.coordsToLatLng(geojson.geometry.coordinates[coordinatesLength-1]));
    }
  }

  function setStartMarker(latLng) {
    if (!startMarker) {
      startMarker = new L.Marker(latLng, {icon:startIcon});
    } else {
      startMarker.setLatLng(latLng);
    }
    map.addLayer(startMarker);
  }

  function setGoalMarker(latLng) {
    if (!goalMarker) {
      goalMarker = new L.Marker(latLng, {icon:goalIcon});
    } else {
      goalMarker.setLatLng(latLng);
    }
    map.addLayer(goalMarker);
  }

  function setLoadingMarker(latLng) {
    if (!loadingMarker) {
      loadingMarker = new L.Marker(latLng, {icon:loadingIcon});
    } else {
      loadingMarker.setLatLng(latLng);
    }
    map.addLayer(loadingMarker);
  }

 </script>

</head>
<body onLoad="doLeaflet();">
 <div id="map"></div>
</body>
</html>
